<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChurnGuard AI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            height: 60px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            flex-shrink: 0;
        }

        .brand { font-weight: 800; font-size: 1.25rem; color: var(--primary); letter-spacing: -0.5px; }
        
        .nav-tabs { display: flex; gap: 1rem; height: 100%; }
        .tab-btn {
            background: none; border: none; height: 100%; padding: 0 1rem;
            font-weight: 600; color: var(--text-muted); cursor: pointer;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- Main Layout --- */
        .main-content {
            flex: 1;
            padding: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .view-section {
            display: none;
            height: 100%;
            width: 100%;
            gap: 1.5rem;
        }
        .view-section.active { display: flex; }

        /* --- Single View Grid --- */
        #single-view { display: none; grid-template-columns: 350px 1fr; }
        #single-view.active { display: grid; }

        /* Left Panel (Form) */
        .panel-form {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .form-grid {
            width: 300px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: span 2; }
        
        label {
            font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
            margin-bottom: 0.4rem; text-transform: uppercase;
        }

        input, select {
            padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.9rem; background: #fff; transition: border 0.2s;
            width: 100%;
        }
        input:focus, select:focus { border-color: var(--primary); }

        .form-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: #f8fafc;
        }

        /* Right Panel (Results) */
        .panel-results {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            padding-right: 5px;
        }

        .kpi-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            height:200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            flex-shrink: 0;
            height: 300px;
        }

        .ai-card {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 1.5rem;
            display: none;
        }

        /* --- Batch View --- */
        #batch-view {
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-zone {
            width: 100%; max-width: 500px;
            border: 2px dashed #cbd5e1; border-radius: 16px;
            padding: 4rem 2rem; text-align: center;
            background: var(--card); transition: all 0.2s;
        }
        .upload-zone:hover { border-color: var(--primary); background: #eff6ff; }

        .batch-report {
            width: 100%; max-width: 900px;
            height: 100%;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .report-header {
            padding: 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .report-content {
            padding: 2rem; overflow-y: auto;
            font-size: 1rem; line-height: 1.6; color: #334155;
        }

        /* --- Components --- */
        .btn {
            width: 100%; padding: 0.75rem; border: none; border-radius: 8px;
            font-weight: 600; font-size: 0.95rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 0.5rem;
            transition: opacity 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid #cbd5e1; color: var(--text); }
        .btn-ai { background: #059669; color: white; display: none; margin-top: 1rem; }
        
        .badge {
            padding: 0.35rem 0.75rem; border-radius: 99px;
            font-size: 0.85rem; font-weight: 700;
        }
        .badge-safe { background: #d1fae5; color: #065f46; }
        .badge-risk { background: #fee2e2; color: #991b1b; }

        .spinner {
            width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Gauge */
        .gauge-container { position: relative; width: 100px; height: 100px; overflow: hidden; }
        .gauge-bg { width: 100px; height: 100px; background: #e2e8f0; border-radius: 50%; }
        .gauge-fill {
            width: 100px; height: 100px; background: var(--danger);
            border-radius: 50%; position: absolute; top: 0; left: 0;
            clip-path: polygon(0 50%, 100% 50%, 100% 0, 0 0);
            transform: rotate(0deg); transform-origin: center; transition: 1s ease;
        }
        .gauge-overlay {
            width: 70px; height: 70px; background: var(--card);
            border-radius: 50%; position: absolute; top: 15px; left: 15px;
            display: flex; align-items: center; justify-content: center; padding-top: 10px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="brand">ChurnGuard AI</div>
    <div class="nav-tabs">
        <button class="tab-btn active" onclick="setTab('single')">Single Prediction</button>
        <button class="tab-btn" onclick="setTab('batch')">Batch Intelligence</button>
    </div>
</div>

<div class="main-content">

    <div id="single-view" class="view-section active">
        <div class="panel-form">
            <form id="churnForm" class="scroll-area">
                <div class="form-grid">
                    <div class="form-group full" style="border-bottom:1px solid #eee; padding-bottom:0.5rem; margin-bottom:0.5rem; color:#94a3b8; font-size:0.75rem; font-weight:700;">CUSTOMER PROFILE</div>
                    
                    <div class="form-group"><label>Gender</label><select name="gender"><option>Male</option><option>Female</option></select></div>
                    <div class="form-group"><label>Senior Citizen</label><select name="SeniorCitizen"><option value="0">No</option><option value="1">Yes</option></select></div>
                    <div class="form-group"><label>Partner</label><select name="Partner"><option>No</option><option>Yes</option></select></div>
                    <div class="form-group"><label>Dependents</label><select name="Dependents"><option>No</option><option>Yes</option></select></div>
                    <div class="form-group"><label>Tenure (Months)</label><input type="number" name="tenure" value="24"></div>
                    
                    <div class="form-group full" style="border-bottom:1px solid #eee; padding-bottom:0.5rem; margin-bottom:0.5rem; margin-top:1rem; color:#94a3b8; font-size:0.75rem; font-weight:700;">SERVICES</div>
                    <div class="form-group"><label>Phone Service</label><select name="PhoneService"><option>Yes</option><option>No</option></select></div>
                    <div class="form-group"><label>Internet</label><select name="InternetService"><option>Fiber optic</option><option>DSL</option><option>No</option></select></div>
                    <div class="form-group"><label>Online Security</label><select name="OnlineSecurity"><option>No</option><option>Yes</option></select></div>
                    <div class="form-group"><label>Tech Support</label><select name="TechSupport"><option>No</option><option>Yes</option></select></div>
                    <div class="form-group"><label>Contract</label><select name="Contract"><option>Month-to-month</option><option>One year</option><option>Two year</option></select></div>
                    <div class="form-group"><label>Payment Method</label><select name="PaymentMethod"><option>Electronic check</option><option>Mailed check</option><option>Bank transfer</option><option>Credit card</option></select></div>
                    
                    <div class="form-group full" style="border-bottom:1px solid #eee; padding-bottom:0.5rem; margin-bottom:0.5rem; margin-top:1rem; color:#94a3b8; font-size:0.75rem; font-weight:700;">FINANCIALS</div>
                    <div class="form-group"><label>Monthly Charges ($)</label><input type="number" name="MonthlyCharges" value="70.0"></div>
                    <div class="form-group"><label>Total Charges ($)</label><input type="number" name="TotalCharges" value="1400.0"></div>
                    
                    <input type="hidden" name="MultipleLines" value="No">
                    <input type="hidden" name="OnlineBackup" value="No">
                    <input type="hidden" name="DeviceProtection" value="No">
                    <input type="hidden" name="StreamingTV" value="No">
                    <input type="hidden" name="StreamingMovies" value="No">
                    <input type="hidden" name="PaperlessBilling" value="Yes">
                </div>
            </form>
            <div class="form-footer">
                <button type="button" id="btnPredict" class="btn btn-primary">Run Prediction</button>
            </div>
        </div>

        <div class="panel-results" id="resultsArea" style="opacity: 0.3; pointer-events: none;">
            <div class="kpi-card">
                <div>
                    <div style="font-size:0.8rem; color:#64748b; font-weight:600">PREDICTION</div>
                    <div id="resBadge" class="badge" style="margin-top:0.25rem">--</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size:0.8rem; color:#64748b; font-weight:600; margin-bottom:0.25rem">CHURN PROBABILITY</div>
                    <div class="gauge-container">
                        <div class="gauge-bg"></div>
                        <div class="gauge-fill" id="resGauge"></div>
                        <div class="gauge-overlay"><span id="resPct" style="font-weight:800; font-size:1.1rem">0%</span></div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div style="font-size:0.8rem; color:#64748b; font-weight:700; margin-bottom:1rem; text-transform:uppercase">Key Drivers (SHAP)</div>
                <div style="height: 240px; position: relative;">
                    <canvas id="shapChart"></canvas>
                </div>
            </div>

            <button id="btnExplain" class="btn btn-ai">
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                Analyze with Gemini AI
            </button>
            
            <div id="aiBox" class="ai-card">
                <div style="font-weight:700; color:#065f46; margin-bottom:0.5rem">Executive Summary</div>
                <div id="aiText" style="font-size:0.9rem; line-height:1.6; color:#064e3b"></div>
            </div>
        </div>
    </div>

    <div id="batch-view" class="view-section">
        
        <div id="batchUpload" class="upload-zone">
            <div style="font-size:3rem; margin-bottom:1rem">ðŸ“‚</div>
            <h2 style="margin:0; font-size:1.5rem; color:var(--text)">Batch Analysis</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem">Upload a CSV file to process multiple customers and generate a strategy.</p>
            <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleFileUpload()">
            <button class="btn btn-primary" onclick="document.getElementById('csvInput').click()" style="width: auto; margin: 0 auto;">
                Select CSV File
            </button>
        </div>

        <div id="batchReport" class="batch-report">
            <div class="report-header">
                <h3 style="margin:0">Strategy Report</h3>
                <div style="display:flex; gap:0.5rem">
                    <button class="btn btn-outline" style="width:auto" onclick="downloadCsv()">Download CSV</button>
                    <button class="btn btn-primary" style="width:auto" onclick="resetBatch()">New Upload</button>
                </div>
            </div>
            <div id="reportContent" class="report-content">
                </div>
        </div>
    </div>

</div>

<script>
    const API_URL = "http://localhost:8000";
    let chartInstance = null;
    let batchDataStore = null;

    // --- Tab Switching ---
    function setTab(mode) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(mode + '-view').classList.add('active');
        // Find button that called this (simple check)
        const btns = document.querySelectorAll('.tab-btn');
        if(mode === 'single') btns[0].classList.add('active');
        else btns[1].classList.add('active');
    }

    // --- Single Prediction Logic ---
    document.getElementById('btnPredict').addEventListener('click', async () => {
        const btn = document.getElementById('btnPredict');
        const resultsArea = document.getElementById('resultsArea');
        
        // UI Reset
        btn.disabled = true; btn.innerHTML = 'Processing... <div class="spinner"></div>';
        resultsArea.style.opacity = '0.3';
        document.getElementById('aiBox').style.display = 'none';
        document.getElementById('btnExplain').style.display = 'none';

        // Prepare Data
        const formData = new FormData(document.getElementById('churnForm'));
        const data = Object.fromEntries(formData.entries());
        
        // Conversions
        data.SeniorCitizen = parseInt(data.SeniorCitizen);
        data.tenure = parseInt(data.tenure);
        data.MonthlyCharges = parseFloat(data.MonthlyCharges);
        data.TotalCharges = String(data.TotalCharges);

        try {
            const res = await fetch(`${API_URL}/predict`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if(!res.ok) throw new Error("API Error");
            const result = await res.json();

            // Render Results
            resultsArea.style.opacity = '1';
            resultsArea.style.pointerEvents = 'all';

            // Badge & Gauge
            const isHigh = result.prediction === 1;
            const prob = result.churn_probability;
            
            const badge = document.getElementById('resBadge');
            badge.textContent = isHigh ? "HIGH RISK" : "SAFE";
            badge.className = isHigh ? "badge badge-risk" : "badge badge-safe";

            document.getElementById('resPct').textContent = (prob * 100).toFixed(0) + "%";
            
            // Rotate gauge (0 to 180deg)
            const deg = prob * 180;
            const gauge = document.getElementById('resGauge');
            gauge.style.transform = `rotate(${deg}deg)`;
            gauge.style.background = prob > 0.5 ? '#ef4444' : '#10b981';

            // Render Chart
            renderChart(result.feature_names, result.shap_values);

            // Show Explain Button
            document.getElementById('btnExplain').style.display = 'flex';

        } catch (e) {
            alert(e.message);
        } finally {
            btn.disabled = false; btn.textContent = 'Run Prediction';
        }
    });

    // --- AI Explain Logic ---
    document.getElementById('btnExplain').addEventListener('click', async () => {
        const btn = document.getElementById('btnExplain');
        btn.disabled = true; btn.innerHTML = 'Analyzing... <div class="spinner"></div>';

        try {
            const res = await fetch(`${API_URL}/explain_shap`, { method: 'POST' });
            const result = await res.json();
            
            document.getElementById('aiBox').style.display = 'block';
            document.getElementById('aiText').innerHTML = result.explanation.replace(/\n/g, '<br>');
            btn.style.display = 'none'; // Hide button after success
        } catch(e) {
            alert(e.message);
            btn.textContent = "Analyze with Gemini AI";
            btn.disabled = false;
        }
    });

    // --- Chart.js Logic ---
    function renderChart(labels, values) {
        const ctx = document.getElementById('shapChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        // Top 5 factors
        const combined = labels.map((n, i) => ({n, v: values[i]})).sort((a,b) => Math.abs(b.v) - Math.abs(a.v)).slice(0,5);

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: combined.map(x => x.n),
                datasets: [{
                    data: combined.map(x => x.v),
                    backgroundColor: combined.map(x => x.v > 0 ? '#ef4444' : '#10b981'),
                    borderRadius: 4,
                    barThickness: 20
                }]
            },
            options: {
                indexAxis: 'y',
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: '#f1f5f9' } },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    // --- Batch Logic ---
    async function handleFileUpload() {
        const input = document.getElementById('csvInput');
        if(!input.files[0]) return;

        const uploadDiv = document.getElementById('batchUpload');
        const reportDiv = document.getElementById('batchReport');
        
        // Show loading state manually on the div
        const originalContent = uploadDiv.innerHTML;
        uploadDiv.innerHTML = '<div class="spinner" style="border-color:#4f46e5; border-top-color:transparent; width:40px; height:40px; margin-bottom:1rem"></div><h3>Analyzing Data...</h3>';
        
        const formData = new FormData();
        formData.append('file', input.files[0]);

        try {
            const res = await fetch(`${API_URL}/predict_batch_analysis`, {
                method: 'POST',
                body: formData
            });

            if(!res.ok) throw new Error("Analysis Failed");
            
            const result = await res.json();
            batchDataStore = result.data; // Store for download

            // Format Report Markdown
            const html = result.strategy_report
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            document.getElementById('reportContent').innerHTML = html;

            // Switch View
            uploadDiv.style.display = 'none';
            reportDiv.style.display = 'flex';
            
            // Restore upload div for next time
            uploadDiv.innerHTML = originalContent;

        } catch(e) {
            alert("Error: " + e.message);
            uploadDiv.innerHTML = originalContent;
        }
    }

    function downloadCsv() {
        if(!batchDataStore) return;
        
        const headers = Object.keys(batchDataStore[0]);
        const csvRows = [headers.join(',')];
        
        for(const row of batchDataStore) {
            const values = headers.map(header => {
                const escaped = ('' + (row[header] || '')).replace(/"/g, '\\"');
                return `"${escaped}"`;
            });
            csvRows.push(values.join(','));
        }

        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'churn_analysis_results.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    function resetBatch() {
        document.getElementById('batchReport').style.display = 'none';
        document.getElementById('batchUpload').style.display = 'block';
        document.getElementById('csvInput').value = '';
        batchDataStore = null;
    }
</script>

</body>
</html>